<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Clash YAML → V2RayN（完整 Reality 支持）</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f7faf9;color:#111;margin:0;padding:20px}
    .wrap{max-width:980px;margin:0 auto}
    textarea{width:100%;min-height:160px;padding:12px;border-radius:8px;border:1px solid #e6e9ee;resize:vertical;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace}
    .row{display:flex;gap:8px;align-items:center}
    button{background:#0f766e;color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.gray{background:#374151}
    .muted{color:#6b7280;font-size:13px}
    pre{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto}
    .small{font-size:13px;color:#374151}
    .label{font-size:13px;color:#374151;margin-bottom:6px;display:block}
  </style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-55EBF07KMP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-55EBF07KMP');
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1722699328777442"
     crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 8px 0">Clash YAML → V2RayN（增强 Reality 支持）</h1>
    <p class="muted">支持：vmess / vless / vless(reality) / trojan / trojan(reality) / ss / hysteria2。会兼容多种 Reality 字段命名并输出可直接导入 V2RayN 的链接。</p>

    <div style="margin-top:12px">
      <label class="label">输入（粘贴 Clash YAML 或上传 .yaml 文件）</label>
      <textarea id="yamlInput" placeholder="在此粘贴 Clash YAML（包含 proxies 数组）..."></textarea>
      <div class="row" style="margin-top:8px">
        <input id="fileInput" type="file" accept=".yaml,.yml,.txt" />
        <button id="loadSample">加载示例</button>
        <button id="convertBtn">转换</button>
        <button id="downloadBtn" class="gray">下载 .txt</button>
        <button id="copyBtn" class="gray">复制结果</button>
      </div>
    </div>

    <div style="margin-top:14px">
      <label class="label">输出（可直接粘贴到 V2RayN）</label>
      <textarea id="output" readonly placeholder="转换结果显示在这里..."></textarea>
    </div>

    <div style="margin-top:12px" id="previewArea"></div>

    <p class="muted" style="margin-top:12px; display:none">注：程序会优先识别 <code>reality-opts</code>、<code>public-key</code> / <code>pbk</code>、<code>short-id</code> / <code>sid</code>、<code>spider-x</code> / <code>spx</code> 等字段，并把对应参数（如 <code>pbk</code>, <code>sid</code>, <code>spx</code>, <code>fp</code>, <code>sni</code>）写入生成的链接 query 中。</p>
  </div>

<script>
/* ---------- helpers ---------- */
function b64utf8(s){ try { return btoa(unescape(encodeURIComponent(s))); } catch(e){ return btoa(s); } }
function decodeB64Safe(s){ try{ return decodeURIComponent(escape(atob(s))); }catch(e){ try{return atob(s);}catch{ return ''; } } }
function fileToText(file, cb){ const r=new FileReader(); r.onload=e=>cb(String(e.target.result||'')); r.readAsText(file); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- file upload ---------- */
document.getElementById('fileInput').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  fileToText(f, txt=>{
    // try decode base64 if no proxies found
    if(!/proxies:/i.test(txt) && /^[A-Za-z0-9+/=\\s]+$/.test(txt.trim())) {
      const dec = decodeB64Safe(txt.trim());
      if(dec && dec.includes('proxies:')) document.getElementById('yamlInput').value = dec;
      else document.getElementById('yamlInput').value = txt;
    } else {
      document.getElementById('yamlInput').value = txt;
    }
  });
});

/* ---------- sample ---------- */
document.getElementById('loadSample').addEventListener('click', ()=>{
  const sample = `proxies:
  - type: trojan
    name: 01(TG:@tccjd)
    server: 209.200.246.53
    port: 10785
    password: D3OJA7xY5U
    network: grpc
    sni: cloudflare.com
    fingerprint: chrome
    tls: true
    reality-opts:
      public-key: Yj8X6ZHfj6UpI7-XxFpodTIoWKiZ5TYbNWj1LQqruCY
      short-id: 20b09680
  - type: vless
    name: 01(TG:@tccjd)_1
    server: 85.208.139.164
    port: 10485
    uuid: 1a31cfd5-ce02-4583-9c1d-6b53e872699c
    network: tcp
    servername: yandex.ru
    tls: true
    encryption: none
    reality-opts:
      public-key: YZ3ASTPmvblzkLF6TyaZj0m5Y2bVYBgRlVQhctxNBG0
      short-id: 968d791b1e349ae4
      spider-x: /
    client-fingerprint: chrome
  - type: vmess
    name: VM-WS-TLS
    server: example.com
    port: 443
    uuid: 11111111-1111-1111-1111-111111111111
    alterId: 0
    cipher: auto
    network: ws
    tls: true
    ws-opts:
      path: /ws
      headers:
        Host: example.com
  - type: ss
    name: SS-1
    server: ss.example.com
    port: 8388
    cipher: aes-128-gcm
    password: passw0rd
  - type: hysteria2
    name: HY2
    server: hy2.example.com
    port: 8443
    password: hy2pass
    sni: hy2.example.com`;
  document.getElementById('yamlInput').value = sample;
});

/* ---------- convert ---------- */
document.getElementById('convertBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('yamlInput').value;
  let doc;
  try { doc = jsyaml.load(txt); } catch(e){ document.getElementById('output').value = 'YAML 解析错误: ' + (e.message||e); return; }
  if(!doc || !Array.isArray(doc.proxies)) { document.getElementById('output').value = '未找到 proxies 数组，请确认输入为 Clash YAML。'; return; }
  const out = [];
  const previewRows = [];
  for(const p of doc.proxies){
    const link = buildLinkFromProxy(p);
    previewRows.push({name: p.name||p.server, type: p.type||p.protocol, ok: !!link});
    if(link) out.push(link);
  }
  document.getElementById('output').value = out.join('\n');
  renderPreview(previewRows);
});

/* ---------- download / copy ---------- */
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('output').value;
  if(!txt){ alert('请先点击“转换”生成结果'); return; }
  const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='v2ray_nodes_'+Date.now()+'.txt'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('copyBtn').addEventListener('click', ()=>{ const out=document.getElementById('output'); out.select(); document.execCommand('copy'); alert('已复制到剪贴板'); });

/* ---------- preview ---------- */
function renderPreview(rows){
  const box = document.getElementById('previewArea');
  if(!rows.length){ box.innerHTML=''; return; }
  const html = ['<div style="margin-top:12px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(12,17,23,.06)">',
    '<strong class="small">已解析节点预览</strong>',
    '<table style="width:100%;border-collapse:collapse;margin-top:8px;font-family:ui-monospace;"><thead><tr style="text-align:left;color:#374151"><th style="padding:8px;border-bottom:1px solid #eef2f7">名称</th><th style="padding:8px;border-bottom:1px solid #eef2f7">类型</th><th style="padding:8px;border-bottom:1px solid #eef2f7">状态</th></tr></thead><tbody>'];
  for(const r of rows){
    html.push(`<tr><td style="padding:8px;border-bottom:1px solid #f3f4f6">${escapeHtml(r.name||'')}</td><td style="padding:8px;border-bottom:1px solid #f3f4f6">${escapeHtml(r.type||'')}</td><td style="padding:8px;border-bottom:1px solid #f3f4f6">${r.ok?'<span style="color:#047857">可转换</span>':'<span style="color:#b91c1c">跳过/未知</span>'}</td></tr>`);
  }
  html.push('</tbody></table></div>');
  box.innerHTML = html.join('');
}

/* ---------- core: build link from proxy ---------- */
function buildLinkFromProxy(p){
  if(!p || !p.type) return null;
  const type = (p.type||'').toLowerCase();
  const displayName = p.name || `${p.server}:${p.port}` || '';
  const nameHash = '#' + encodeURIComponent(displayName);

  // gather reality-like fields from different names
  function getReality(proxy){
    const r = proxy['reality-opts'] || proxy.reality || {};
    return {
      pbk: r['public-key'] || r.publicKey || r.pbk || proxy.pbk || proxy['public-key'] || undefined,
      sid: r['short-id'] || r.shortId || r.sid || proxy.sid || proxy['short-id'] || undefined,
      spx: r['spider-x'] || r.spx || r.sp || r.spa || proxy['spider-x'] || proxy.spx || undefined,
      fp: proxy['client-fingerprint'] || proxy.fingerprint || proxy.fp || r.fp || undefined
    };
  }

  // --- vmess ---
  if(type==='vmess'){
	// ✅ 修复 TLS 逻辑
	let tlsValue = '';
	if (typeof p.tls === 'boolean') {
	  if (p.tls === true) tlsValue = 'tls';
	} else if (typeof p.tls === 'string') {
	  if (p.tls.toLowerCase() === 'tls' || p.tls.toLowerCase() === 'true') tlsValue = 'tls';
	} else if (typeof p.security === 'string') {
	  if (p.security.toLowerCase() === 'tls') tlsValue = 'tls';
	}
	  
	const vmess = {
	  v: "2",
	  ps: displayName,
	  add: p.server||'',
	  port: String(p.port||''),
	  id: p.uuid || p.id || '',
	  aid: String(p.alterId || p.aid || p['alterId'] || 0),
	  net: p.network || p.net || 'tcp',
	  type: p.headerType || p.header || 'none',
	  host: (p['ws-opts'] && p['ws-opts'].headers && p['ws-opts'].headers.Host) ? p['ws-opts'].headers.Host : (p.host||''),
	  path: (p['ws-opts'] && p['ws-opts'].path) ? p['ws-opts'].path : (p.path||''),
	  tls: tlsValue
	};
    return 'vmess://' + b64utf8(JSON.stringify(vmess));
  }

  // --- vless (含 Reality 与普通) ---
  if(type==='vless'){
    const uuid = p.uuid || p.id || '';
    const params = new URLSearchParams();

    // 默认加密
    const encryption = (p.encryption === undefined) ? (p.encryption || 'none') : (p.encryption);
    params.set('encryption', encryption || 'none');

    const securityField = (p.security || p.tls || '').toString().toLowerCase();
    const realityPresent = securityField === 'reality' || p['reality-opts'] || p.reality;

    if(realityPresent){
      // ✅ VLESS Reality
      params.set('security','reality');
      params.set('flow','xtls-rprx-vision');
      const r = getReality(p);
      if(r.pbk) params.set('pbk', r.pbk);
      if(r.sid) params.set('sid', r.sid);
      if(r.spx) params.set('spx', encodeURIComponent(r.spx));
      if(r.fp) params.set('fp', r.fp);
      const sni = p.sni || p.servername || p.host || p['server-name'] || undefined;
      if(sni) params.set('sni', sni);
    } else {
      // ✅ 普通 VLESS TLS/WS
      if(p.tls || securityField === 'tls') {
        params.set('security','tls');
        const sni = p.sni || p.servername || undefined;
        if(sni) params.set('sni', sni);
      }
    }
	
      // ✅ 新增 skip-cert-verify → allowInsecure 映射
      if (typeof p['skip-cert-verify'] !== 'undefined') {
        params.set('allowInsecure', p['skip-cert-verify'] ? '1' : '0');
      } else {
        params.set('allowInsecure', '0');
      }

    // ✅ 处理 ws-opts.path 与 ws-opts.headers.Host
    if (p['ws-opts']) {
      if (p['ws-opts'].path) params.set('path', p['ws-opts'].path);
      if (p['ws-opts'].headers && p['ws-opts'].headers.Host) params.set('host', p['ws-opts'].headers.Host);
    }

    // ✅ 若未设置 ws-opts.host，则尝试普通 host 字段
    if (p.host && !params.has('host')) params.set('host', p.host);
    if (p.path && !params.has('path')) params.set('path', p.path);

    if (p.network) params.set('type', p.network);
    if (p.headerType) params.set('headerType', p.headerType);
    if (p.alpn) params.set('alpn', Array.isArray(p.alpn)?p.alpn.join(','):p.alpn);
    if (p['client-fingerprint'] || p.fp) params.set('fp', p['client-fingerprint'] || p.fp);

    const q = params.toString();
    return `vless://${uuid}@${p.server||''}:${p.port||''}${q?('?'+q):''}${nameHash}`;
  }

  // --- trojan (incl. reality) ---
  if (type === 'trojan') {
	const pwd = p.password || p.pass || p.psw || '';
	const params = new URLSearchParams();
	const securityField = (p.security || p.tls || '').toString().toLowerCase();
	const realityPresent = securityField === 'reality' || p['reality-opts'] || p.reality;
  
	if (realityPresent) {
	  // ✅ trojan Reality 不添加 allowInsecure
	  params.set('security', 'reality');
	  const r = getReality(p);
	  if (r.pbk) params.set('pbk', r.pbk);
	  if (r.sid) params.set('sid', r.sid);
	  if (r.spx) params.set('spx', r.spx);
	  if (r.fp) params.set('fp', r.fp);
	  const sni = p.sni || p.servername || undefined;
	  if (sni) params.set('sni', sni);
	} else {
	  // ✅ 普通 trojan TLS，添加 allowInsecure=1
	  if (p.tls || securityField === 'tls') {
		params.set('security', 'tls');
		if (p.sni) params.set('sni', p.sni);
		params.set('allowInsecure', '1'); // ✅ 新增
	  }
	}
  
	// ✅ fingerprint → fp 支持
	if (p.fingerprint || p['client-fingerprint']) {
	  params.set('fp', p.fingerprint || p['client-fingerprint']);
	}
  
	if (p.type) params.set('type', p.type);
	if (p.network) params.set('type', p.network);
  
	// ✅ encode ws path
	if (p['ws-opts'] && p['ws-opts'].path) {
	  params.set('path', encodeURIComponent(p['ws-opts'].path));
	}
  
	if (p.path && !params.has('path')) {
	  params.set('path', encodeURIComponent(p.path));
	}
  
	if (p.alpn) {
	  params.set('alpn', Array.isArray(p.alpn) ? p.alpn.join(',') : p.alpn);
	}
  
	if (p.headerType) params.set('headerType', p.headerType);
  
	const q = params.toString();
	return `trojan://${pwd}@${p.server || ''}:${p.port || ''}${q ? '?' + q : ''}${nameHash}`;
  }

  // --- shadowsocks ---
  if(type==='ss' || type==='shadowsocks'){
    const method = p.cipher || p.method || 'aes-128-gcm';
    const password = p.password || p.pass || '';
    // ss://BASE64(method:password@host:port)#name
    const user = `${method}:${password}@${p.server||''}:${p.port||''}`;
    return 'ss://' + b64utf8(user) + nameHash;
  }

  // --- hysteria2 ---
  if(type.indexOf('hysteria')===0){
	const pwd = p.password || p.pass || '';
	const params = new URLSearchParams();
  
	if(p.sni) params.set('sni', p.sni);
	if(p.alpn) params.set('alpn', Array.isArray(p.alpn)?p.alpn.join(','):p.alpn);
	if(p.obfs) params.set('obfs', p.obfs);
  
	// ✅ 新增 skip-cert-verify → insecure 映射
	if (typeof p['skip-cert-verify'] !== 'undefined') {
	  params.set('insecure', p['skip-cert-verify'] ? '1' : '0');
	}
	
    // ✅ 新增支持 mport / ports 字段
    if (p.mport) {
      params.set('mport', p.mport);
    } else if (p.ports) {
      params.set('mport', p.ports);
    }
  
	const q = params.toString();
	return `hysteria2://${encodeURIComponent(pwd)}@${p.server||''}:${p.port||''}${q?('?'+q):''}${nameHash}`;
  }

  return null;
}
</script>

<div style="max-width:1000px; margin:0 auto;"><hr style="margin:3em 0 4em 0; border:none; border-bottom:2px dotted #CCC;" /></div>
<div style="text-align:center; max-width:1000px; margin:0 auto; background:#FFF; border-radius:0.2em; padding:0 0.2em;">
<h2 style="font-size:2em; padding:0.5em 0 0 0; font-weight:bold;">使用说明：</h2>
<img style="width:100%;" src="images/tips1.png" />
</div>
<div style="text-align:center; padding:1em;">Copyright © 天天科技教学 <a href="https://www.youtube.com/@kjfx8" target="_blank">YouTube频道</a></div>
</body>
</html>
